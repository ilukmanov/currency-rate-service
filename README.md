# Currency Rate Service

## Описание проекта

Данный проект представляет собой микросервис для получения курсов валют, который использует PHP 8.3 и микрофреймворк Webman, основанный на Workerman, высокопроизводительном асинхронном PHP сервере, заточенном под HighLoad. Его, кстати, использует Alibaba и AliExpress.

## Основные технологии

- PHP 8.3 (FPM)
- [Webman Framework](https://webman.workerman.net/doc/ru/)
- Redis
- Docker и Docker Compose

## Требования

Перед запуском убедитесь, что на вашем компьютере установлены следующие компоненты:

- [Docker](https://www.docker.com/get-started)
- [Docker Compose](https://docs.docker.com/compose/install/)

## Установка и запуск

Для запуска проекта выполните следующие шаги:

1. **Клонируйте репозиторий:**
   ```sh
   git clone https://github.com/ilukmanov/currency-rate-service.git
   cd currency-rate-service
   ```
2. **Создайте файл .env:**
    
    Создайте файл .env на основе примера .env.example и отредактируйте его, если необходимо.
    ```sh
    cp .env.example .env
    ```
3. **Запустите контейнеры с Docker Compose:**
    
    Используйте следующую команду для сборки и запуска контейнеров в фоновом режиме:
    ```sh
    docker-compose up -d --build
    ```
4. **Проверьте статус контейнеров:**
    
    Чтобы убедиться, что контейнеры успешно запущены, выполните команду:
    ```sh
    docker-compose ps
    ```

4. **Доступ к приложению:**
    
    После успешного запуска ваше приложение будет доступно по адресу:
    
    http://localhost:8080

## Документация

Документация представлена в формате OpenAPI 3.0.

Вы можете импортировать её в Postman: [скачать](https://cbr.lukmanov.net/docs/openapi.yaml)

Либо использовать веб-интерфейс Swagger Editor для тестирования:

* На тестовом сервере cbr.lukmanov.net: https://cbr.lukmanov.net/docs/index.html
* Локально: http://localhost:8080/docs/index.html

## Пример запроса

Поскольку API реализует всего 1 GET метод, вы также можете протестировать его в любом браузере, посредством отправки запроса:

* На тестовом сервере cbr.lukmanov.net: https://cbr.lukmanov.net/api/currency-rate?date=2024-09-27&currency=USD&base_currency=RUR
* Локально: http://localhost:8080/api/currency-rate?date=2024-09-27&currency=USD&base_currency=RUR

## Кэширование

Реализовано двухуровневое кэширование.

Холодный кэш хранится в JSON файлах в директории **runtime/cache/currency** (в production режиме можно увидеть только внутри контейнера).

Горячий кэш хранится в памяти, в статическом массиве. Если что - я знаю, как хранить кэш в Redis. Просто в случае с Workerman - появляется возможность использовать сверхбыстрый кэш в памяти, так как это application сервер. Поэтому задействовал его, для максимальных результатов по производительности.

## Сбор данных с cbr.ru / прогрев кэша

Осуществляется запуском команды:
```sh
php webman currency:enqueue 180
```
где 180 - количество дней, которые нужно загрузить/прогреть

Для запуска внутри контейнера:
```sh
docker-compose exec app php webman currency:enqueue 180
```

После выполнения команды, появится подтверждение:
```sh
Задача на загрузку курсов за последние 180 дней успешно добавлена в очередь.
```

В очередь Redis добавится задача на загрузку данных.

Консьюмер app/queue/redis/CurrencyRates.php возьмёт задачу в работу и будет загружать данные с cbr.ru с паузой 0.5 секунд между запросами.

Убедиться, что загрузка прошла успешно можно по логам:
```sh
docker-compose exec app tail runtime/logs/webman-2024-09-29.log
```
где вместо 2024-09-29 нужно подставить сегодняшнюю дату.

А ещё можно посмотреть, что появились директории и файлы с холодным кэшем:
```sh
docker-compose exec app ls runtime/cache/currency/2024
```
```sh
docker-compose exec app ls runtime/cache/currency/2024/09
```

## Unit тесты

Покрытие кода Unit тестами составляет: ~67%
Поскольку это тестовое задание - у меня не было цели достичь 100% покрытия. Я лишь хотел показать пример Unit тестов.
Статистику покрытия Unit тестами можно посмотреть здесь: https://cbr.lukmanov.net/coverage/index.html

## Нагрузочное тестирование

Поскольку я немного увлекаюсь HighLoad-ом, я реализовал микросервис на Webman+Workerman. Workerman входит в топ-3 самых производительных в мире, на данный момент. На 2 ядрах (из 8 возможных) MacBook Air на процессоре M1 удалось достичь производительности в 26933 rps (запросов в секунду).

Конфиг нагрузочного теста JMeter находится в директории **jmeter** и вы можете провести нагрузочное тестирование на своём железе.

С подробными результатами нагрузочного тестирования можно ознакомиться здесь: https://cbr.lukmanov.net/jmeter/index.html